// -----------------------------------------------------
// BribeBank Prisma Schema (Parent + Child Accounts)
// -----------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------
// FAMILY
// One family, many users, rewards, bounties
// -----------------------------------------------------

model Family {
  id        String    @id @default(cuid())
  name      String
  createdAt DateTime  @default(now())

  joinCode       String?   @unique
  joinCodeExpiry DateTime?

  users     User[]
  bounties  Bounty[]
  rewards   Reward[]
  assignedPrizes    AssignedPrize[]
  bountyAssignments BountyAssignment[]
  historyEvents     HistoryEvent[]
}

// -----------------------------------------------------
// USER (Parent or Child)
// -----------------------------------------------------

model User {
  id          String     @id @default(cuid())
  familyId    String
  family      Family     @relation(fields: [familyId], references: [id])

  username    String     @unique
  password    String
  displayName String
  role        Role       @default(CHILD) // PARENT or CHILD
  avatarColor String?    @default("bg-blue-500")

  createdAt   DateTime   @default(now())

  notifications Notification[]
  claims        Claim[]
  assignedPrizes    AssignedPrize[]
  bountyAssignments BountyAssignment[]
  historyEvents     HistoryEvent[]

  @@index([familyId, createdAt])
}

enum Role {
  PARENT
  CHILD
}

enum PrizeStatus {
  AVAILABLE
  PENDING_APPROVAL
  REDEEMED
}

enum PrizeType {
  FOOD
  ACTIVITY
  PRIVILEGE
}

enum BountyStatus {
  OFFERED
  IN_PROGRESS
  COMPLETED
  VERIFIED
}

// -----------------------------------------------------
// BOUNTY (chores / tasks children can do)
// -----------------------------------------------------

model Bounty {
  id         String    @id @default(cuid())
  familyId   String
  family     Family    @relation(fields: [familyId], references: [id])

  title       String
  emoji       String
  rewardValue String   // e.g. "$5" or "Ice Cream"
  themeColor      String?  // e.g. "bg-amber-500 text-white"

  rewardTemplateId String?
  rewardTemplate   Reward? @relation("BountyRewardTemplate", fields: [rewardTemplateId], references: [id])

  isFCFS     Boolean   @default(false)

  createdAt  DateTime  @default(now())

  assignments BountyAssignment[]

  @@index([familyId, createdAt])  
}

// -----------------------------------------------------
// REWARD (redeemable rewards banks)
// -----------------------------------------------------

model Reward {
  id         String    @id @default(cuid())
  familyId   String
  family     Family    @relation(fields: [familyId], references: [id])

  title       String
  emoji       String
  description String?

  type       PrizeType @default(FOOD)
  themeColor String?

  createdAt      DateTime        @default(now())
  claims         Claim[]
  assignedPrizes AssignedPrize[]

  // Back relation to Bounty.rewardTemplate
  bountyTemplates Bounty[] @relation("BountyRewardTemplate")

  @@index([familyId, createdAt])
}

// -----------------------------------------------------
// CLAIM (a child redeems a reward)
// -----------------------------------------------------

model Claim {
  id         String    @id @default(cuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id])

  rewardId   String
  reward     Reward    @relation(fields: [rewardId], references: [id])

  createdAt  DateTime  @default(now())

  @@index([userId, createdAt])
}

// -----------------------------------------------------
// ASSIGNED PRIZES
// -----------------------------------------------------

model AssignedPrize {
  id          String      @id @default(cuid())
  familyId    String
  family      Family      @relation(fields: [familyId], references: [id])

  templateId  String?
  reward      Reward?     @relation(fields: [templateId], references: [id], onDelete: SetNull)

  userId      String
  user        User        @relation(fields: [userId], references: [id])

  assignedBy  String
  status      PrizeStatus @default(AVAILABLE)

  assignedAt  DateTime    @default(now())
  claimedAt   DateTime?
  redeemedAt  DateTime?

  // SNAPSHOT FIELDS â€“ what the child actually sees
  title       String
  emoji       String
  description String?
  type        PrizeType
  themeColor  String?

  @@index([familyId, userId, status])
  @@index([userId, status])
  @@index([familyId, assignedAt])
}

// -----------------------------------------------------
// BOUNTY ASSIGNMENTS
// -----------------------------------------------------

model BountyAssignment {
  id          String       @id @default(cuid())
  familyId    String
  family      Family       @relation(fields: [familyId], references: [id])

  bountyId    String
  bounty      Bounty       @relation(fields: [bountyId], references: [id])

  userId      String
  user        User         @relation(fields: [userId], references: [id])

  assignedBy  String
  status      BountyStatus @default(OFFERED)

  assignedAt  DateTime     @default(now())
  completedAt DateTime?

  @@index([familyId, userId])
  @@index([familyId, status])
}

// -----------------------------------------------------
// HISTORY EVENTS
// -----------------------------------------------------

model HistoryEvent {
  id           String   @id @default(cuid())
  familyId     String
  family       Family   @relation(fields: [familyId], references: [id])

  userId       String
  user         User     @relation(fields: [userId], references: [id])

  userName     String
  title        String
  emoji        String
  action       String
  assignerName String

  createdAt    DateTime @default(now())

  @@index([familyId, userId, createdAt])
}

// -----------------------------------------------------
// NOTIFICATIONS
// -----------------------------------------------------

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, isRead])
}